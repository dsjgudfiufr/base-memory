# 📝 Prompt 模板 — bm-dispatch 使用

> bm-dispatch 代码驱动调度器在调用 LLM 时使用的 prompt 模板。
> 这些模板由 `buildPrompt()` 函数动态拼装，以下是完整格式说明。

## 任务执行 Prompt 模板（完整版）

```markdown
## 任务目标
{任务名称}

## 原始指令
{用户原始指令文本}

## 整体规划
{任务规划字段内容，含子任务列表}

## 当前进度
{子任务进度列表，格式如下}
✅ 子任务A
📍 子任务B ← 当前
○ 子任务C

## 当前子任务
名称：{子任务名}
要求：{从规划中提取的子任务描述}

## 关键发现和决策（从日志表）
- [🔍 发现] {finding 内容}
- [🧭 决策] {decision 内容}
- [❌ 错误] {error 内容}

## 产出物路径
{从 resource 日志中提取的文件路径}

## 输出格式
完成后输出 JSON：{"status":"done","summary":"一句话摘要","files":["产出文件路径"]}
遇到阻塞：{"status":"blocked","reason":"原因"}
失败：{"status":"error","message":"错误信息"}
```

### 字段说明

| 字段 | 来源 | 说明 |
|---|---|---|
| 任务目标 | 任务表 `任务名称` | 始终存在 |
| 原始指令 | 任务表 `原始指令` | 用户原话，可能为空 |
| 整体规划 | 任务表 `任务规划` | 含子任务列表，可能为空 |
| 当前进度 | 解析 `任务规划` 中的子任务 | 无子任务时用 `当前阶段` 字段 |
| 当前子任务 | `findFirstIncompleteSubtask()` | 无子任务时省略此段 |
| 关键发现 | 日志表最近 10 条日志 | 查询失败时省略 |
| 产出物路径 | 日志表 resource 类型日志 | 从内容中正则提取文件路径 |

## 子任务执行 Prompt

子任务 prompt 和主任务 prompt 结构相同，区别在于：
- `当前子任务` 段落会出现，指明当前要执行的子任务
- `当前进度` 显示所有子任务的完成状态（✅/📍/○）
- LLM 只需专注执行当前子任务，返回结果 JSON

## 结果 JSON 格式规范

### 成功完成

```json
{
  "status": "done",
  "summary": "一句话描述做了什么（≤200字）",
  "files": ["/path/to/output1.md", "/path/to/output2.py"]
}
```

- `summary`：必填，会写入任务表 `结果摘要` 字段（自动截断 200 字）
- `files`：可选，产出文件路径列表

### 阻塞（需人工介入）

```json
{
  "status": "blocked",
  "reason": "缺少 API 权限，需要 owner 授权 task:task:write scope"
}
```

- 触发：自动标记任务为 `🔒阻塞` + 飞书通知 owner
- `reason`：必填，写入阻塞日志

### 失败

```json
{
  "status": "error",
  "message": "API 返回 403，权限不足"
}
```

- 触发：错误计数 +1，当前阶段追加 `⚠️ 第N次失败`
- 第 5 次失败：自动 block + 飞书通知
- `message`：必填，写入错误日志

### 解析容错

bm-dispatch 的 `extractResultJSON()` 支持多种格式：
1. 纯 JSON 字符串
2. Markdown code block 中的 JSON
3. 混合文本中的 JSON 对象（贪心匹配）
4. 关键词兜底（含 "blocked"/"error" 关键词）
5. 无法解析时默认为 `done`，整个输出当 summary

## 错误重试 Prompt

当任务之前失败过，prompt 中会包含历史错误日志：

```markdown
## 关键发现和决策（从日志表）
- [❌ 错误] 第1次失败：API 返回 403，权限不足
- [❌ 错误] 第2次失败：换用 v2 API 仍然 403

## 当前进度
⚠️ 阶段3-实现（第2次失败，需换方法）
```

LLM 看到历史错误后，应该：
1. 分析之前失败的原因
2. 选择**完全不同的方法**（不是微调参数）
3. 如果无法解决，返回 `{"status": "blocked", "reason": "..."}`

> **铁律：不允许用相同方法重试。** bm-dispatch 会在当前阶段字段标记失败次数，提醒 LLM 必须换方法。
